<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Tracker — Chart.js</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#111; --muted:#6b7280;
      --green:#16a34a; --red:#ef4444; --accent:#2563eb;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:12px; background:var(--bg); color:var(--text)}
    h2{margin:6px 0 10px;font-size:18px}
    .controls{display:grid;grid-template-columns: 1fr 1fr auto;gap:8px;align-items:center}
    .controls input, .controls button{padding:8px;border-radius:8px;border:1px solid #d1d5db;background:#fff;font-size:14px}
    .row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .row button, .row input{flex:1 1 auto; min-width:120px}

    table{width:100%;border-collapse:collapse;margin-top:10px;background:var(--card);border-radius:10px;overflow:hidden;font-size:14px}
    th,td{padding:8px;border:1px solid #e6e7ea;text-align:center}
    th{background:#fafafa}
    .btn-hapus{color:var(--red);cursor:pointer;font-weight:700}
    .persen-plus{color:var(--green);font-weight:700}
    .persen-minus{color:var(--red);font-weight:700}

    .chart-wrap{margin-top:12px;background:var(--card);padding:12px;border-radius:10px;border:1px solid #e6e7ea}
    canvas{width:100%!important;height:360px!important;display:block}

    .summary{margin-top:12px;background:var(--card);padding:12px;border-radius:10px;border:1px solid #e6e7ea;font-size:14px}
    .summary h3{margin:6px 0;font-size:15px;color:var(--muted)}

    @media (max-width:520px){
      .controls{grid-template-columns:1fr 1fr}
      canvas{height:300px!important}
    }
  </style>
</head>
<body>
  <h2>Daily Tracker</h2>

  <div class="controls">
    <input type="date" id="tanggal" />
    <input type="number" id="nilai" placeholder="Masukkan nilai" />
    <button id="btnTambah">Tambah</button>
  </div>

  <div class="row">
    <button id="btnBackup">Backup JSON</button>
    <input type="file" id="fileRestore" />
    <button id="btnReset" style="background:#fff1f2;border:1px solid #f3c4c4">Reset</button>
  </div>

  <table>
    <thead>
      <tr><th>Tanggal</th><th>Nilai</th><th>Selisih</th><th>Aksi</th></tr>
    </thead>
    <tbody id="dataTabel"></tbody>
  </table>

  <div class="chart-wrap">
    <canvas id="grafik"></canvas>
  </div>

  <div class="summary">
  <h3>Total per Minggu</h3>
  <table>
    <thead><tr><th>Minggu</th><th>Total</th><th>Selisih</th></tr></thead>
    <tbody id="sum-week"></tbody>
  </table>

  <h3>Total per Bulan</h3>
  <table>
    <thead><tr><th>Bulan</th><th>Total</th><th>Selisih</th></tr></thead>
    <tbody id="sum-month"></tbody>
  </table>
</div>

  <script>
    // ===== state & utils =====
    let data = JSON.parse(localStorage.getItem('trackerData') || '[]');
    const fmt = v => Number(v).toLocaleString('id-ID');
    const toYMD = d => new Date(d).toISOString().split('T')[0];

    document.getElementById('tanggal').value = toYMD(new Date());

    const tbody = document.getElementById('dataTabel');
    const btnTambah = document.getElementById('btnTambah');
    const btnBackup = document.getElementById('btnBackup');
    const fileRestore = document.getElementById('fileRestore');
    const btnReset = document.getElementById('btnReset');

    // ===== Chart.js setup =====
    const ctx = document.getElementById('grafik').getContext('2d');
    let chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Nilai Harian',
          data: [],
          borderColor: 'rgba(37,99,235,1)',
          backgroundColor: 'rgba(37,99,235,0.08)',
          tension: 0.25,
          pointRadius: 3,
          pointHoverRadius: 5,
          fill: true,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const i = context.dataIndex;
                const val = context.parsed.y;
                if (i > 0) {
                  const prev = context.dataset.data[i-1];
                  const pct = prev === 0 ? 0 : ((val - prev) / prev * 100);
                  const sign = pct >= 0 ? '+' : '';
                  return `${fmt(val)} (${sign}${pct.toFixed(1)}%)`;
                }
                return fmt(val);
              }
            }
          }
        },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } },
          y: { ticks: { callback: v => fmt(v) } }
        }
      }
    });

    // ===== render table, chart, summary =====
    function renderAll() {
      data.sort((a,b) => a.tanggal > b.tanggal ? 1 : -1);
      localStorage.setItem('trackerData', JSON.stringify(data));

      // tabel
      tbody.innerHTML = '';
      data.forEach((d,i) => {
        const tr = document.createElement('tr');

        const hari = new Date(d.tanggal).toLocaleDateString('id-ID', { weekday: 'long' });
        const tdTgl = document.createElement('td');
        tdTgl.textContent = `${hari}, ${d.tanggal}`;
        tdTgl.ondblclick = () => {
          const inp = document.createElement('input'); inp.type='date'; inp.value=d.tanggal;
          inp.onblur = ()=>{ d.tanggal = inp.value || d.tanggal; renderAll(); };
          tdTgl.innerHTML=''; tdTgl.appendChild(inp); inp.focus();
        };

        const tdNil = document.createElement('td');
        tdNil.textContent = fmt(d.nilai);
        tdNil.ondblclick = () => {
          const inp = document.createElement('input'); inp.type='number'; inp.value=d.nilai;
          inp.onblur = ()=>{ d.nilai = parseInt(inp.value)||0; renderAll(); };
          tdNil.innerHTML=''; tdNil.appendChild(inp); inp.focus();
        };

        const tdPct = document.createElement('td');
        if (i > 0) {
          const prev = data[i-1].nilai;
          const pct = prev === 0 ? 0 : ((d.nilai - prev) / prev * 100);
          tdPct.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%`;
          tdPct.className = pct >= 0 ? 'persen-plus' : 'persen-minus';
        } else tdPct.textContent = '-';

        const tdAct = document.createElement('td');
        const del = document.createElement('span');
        del.textContent = '🗑️'; del.className = 'btn-hapus';
        del.onclick = ()=>{ if(confirm(`Hapus data ${d.tanggal}?`)){ data.splice(i,1); renderAll(); } };
        tdAct.appendChild(del);

        tr.appendChild(tdTgl); tr.appendChild(tdNil); tr.appendChild(tdPct); tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });

      // chart
      chart.data.labels = data.map(x => x.tanggal);
      chart.data.datasets[0].data = data.map(x => x.nilai);
      chart.update();

      // summary
      updateSummary();
    }

    function getWeekNumber(d) {
  const date = new Date(d);
  
  const firstMonday = new Date(date.getFullYear(), 0, 1);
  while (firstMonday.getDay() !== 1) { // 1 = Senin
    firstMonday.setDate(firstMonday.getDate() + 1);
  }
  const diff = (date - firstMonday) / (1000 * 60 * 60 * 24);
  return Math.floor(diff / 7) + 1;
}

    function updateSummary() {
  const weekSum = {};
  const monthSum = {};

  data.forEach(d => {
    const week = getWeekNumber(d.tanggal);
    const month = new Date(d.tanggal).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
    weekSum[week] = (weekSum[week] || 0) + d.nilai;
    monthSum[month] = (monthSum[month] || 0) + d.nilai;
  });

  // render helper
  function renderTable(obj, tbodyId, labelPrefix) {
    const entries = Object.entries(obj).sort((a,b) => a[0] > b[0] ? 1 : -1);
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = '';
    let prev = null;
    entries.forEach(([key, total]) => {
      const tr = document.createElement('tr');
      const tdLabel = document.createElement('td');
      tdLabel.textContent = labelPrefix + ' ' + key;
      const tdTotal = document.createElement('td');
      tdTotal.textContent = fmt(total);
      const tdPct = document.createElement('td');
      if (prev !== null) {
        const pct = prev === 0 ? 0 : ((total - prev) / prev * 100);
        tdPct.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%`;
        tdPct.className = pct >= 0 ? 'persen-plus' : 'persen-minus';
      } else tdPct.textContent = '-';
      tr.appendChild(tdLabel);
      tr.appendChild(tdTotal);
      tr.appendChild(tdPct);
      tbody.appendChild(tr);
      prev = total;
    });
  }

  renderTable(weekSum, 'sum-week', 'Minggu');
  renderTable(monthSum, 'sum-month', '');
}

    // ===== events =====
    btnTambah.onclick = () => {
      const t = document.getElementById('tanggal').value || toYMD(new Date());
      const v = parseInt(document.getElementById('nilai').value);
      if (isNaN(v)) return;
      data.push({ tanggal: t, nilai: v });
      document.getElementById('nilai').value = '';
      renderAll();
    };

    btnBackup.onclick = () => {
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'tracker-backup.json'; a.click();
      URL.revokeObjectURL(url);
    };

    fileRestore.onchange = (e) => {
      const f = e.target.files[0]; if (!f) return;
      const r = new FileReader();
      r.onload = ()=> {
        try {
          const parsed = JSON.parse(r.result);
          if (!Array.isArray(parsed)) throw new Error('not array');
          data = parsed.map(x => ({ tanggal: x.tanggal, nilai: parseInt(x.nilai) || parseInt(x.value) || 0 }))
                       .filter(x => x.tanggal);
          renderAll();
        } catch (err) {
          alert('File rusak atau bukan JSON');
        }
      };
      r.readAsText(f);
    };

    btnReset.onclick = () => {
      if (confirm('Yakin reset semua data?')) { data = []; renderAll(); }
    };

    // ===== init =====
    renderAll();
  </script>
</body>
</html>
